<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Avatar Player</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body style="margin:0; background:black; overflow:hidden;">
  <canvas id="canvas"></canvas>

  <script>
    // Forward console.log to Flutter
    console.log = (msg) => {
      if (window.ConsoleLog) {
        ConsoleLog.postMessage(msg);
      }
    };

    async function playAvatar(glbUrl, audioUrl, visemes) {
      console.log("ðŸŽ¬ Starting avatar playback", glbUrl, audioUrl);

      // === Scene setup ===
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
      const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000);

      const ambient = new THREE.AmbientLight(0xffffff, 1.2);
      scene.add(ambient);
      const dirLight = new THREE.DirectionalLight(0xffffff, 2);
      dirLight.position.set(0, 1, 2);
      scene.add(dirLight);

      // Resize handling
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // === Load GLB ===
      const loader = new THREE.GLTFLoader();
      let meshes = [];
      loader.load(
        glbUrl,
        function (gltf) {
          const model = gltf.scene;
          model.scale.set(1.5, 1.5, 1.5);
          scene.add(model);

          // Collect all SkinnedMeshes
          model.traverse((child) => {
            if (child.isSkinnedMesh && child.morphTargetInfluences) {
              meshes.push(child);
            }
          });

          console.log(`âœ… Model loaded with ${meshes.length} skinned meshes!`);

          // Center camera on model
          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          camera.position.set(center.x, center.y + size.y / 2, size.z * 2);
          camera.lookAt(center);

          // === Load and play audio ===
          const audio = new Audio(audioUrl);
          audio.addEventListener('playing', () => {
            const start = performance.now();

            // === Animate visemes ===
            function animate() {
              const elapsed = performance.now() - start;
              const current = visemes.findLast(v => v.offsetMs <= elapsed);

              if (current) {
                meshes.forEach(mesh => {
                  const keys = Object.keys(mesh.morphTargetDictionary);
                  keys.forEach(k => mesh.morphTargetInfluences[mesh.morphTargetDictionary[k]] = 0);

                  const visemeKey = "viseme_" + current.visemeId;
                  if (mesh.morphTargetDictionary[visemeKey] !== undefined) {
                    mesh.morphTargetInfluences[mesh.morphTargetDictionary[visemeKey]] = 1;
                  }
                });
              }

              renderer.render(scene, camera);
              requestAnimationFrame(animate);
            }
            animate();
          });

          audio.play();
        },
        undefined,
        function (error) {
          console.error("âŒ GLB load error:", error);
        }
      );
    }

    // Listen for message from Flutter
    window.addEventListener('message', event => {
      console.log("ðŸ“© Message received from Flutter:", event.data);
      const { glbUrl, audioUrl, visemes } = event.data;
      playAvatar(glbUrl, audioUrl, visemes);
    });
  </script>
</body>
</html>
